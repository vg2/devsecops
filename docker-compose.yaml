version: '3.8'

services:
  library-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    user: root
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=MyComplexPass123
    ports:
      - "1433:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P MyComplexPass123 -C -Q 'SELECT 1' || exit 1"]
      interval: 10s
      retries: 20
      start_period: 60s
      timeout: 10s

  db-init:
      image: mcr.microsoft.com/mssql-tools
      depends_on:
        library-db:
          condition: service_healthy
      # Using specific quoting to handle SQL single quotes vs Bash double quotes
      command: >
        /bin/bash -c "
        /opt/mssql-tools/bin/sqlcmd -S library-db -U sa -P MyComplexPass123 -C -Q \"IF NOT EXISTS(SELECT * FROM sys.databases WHERE name='LibraryDB') CREATE DATABASE LibraryDB\"
        &&
        /opt/mssql-tools/bin/sqlcmd -S library-db -U sa -P MyComplexPass123 -C -d LibraryDB -Q \"IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Book' and xtype='U') CREATE TABLE Book (id INT IDENTITY(1,1) PRIMARY KEY, title VARCHAR(255) NOT NULL, author VARCHAR(255) NOT NULL, isbn VARCHAR(50))\"
        "

  # 3. The Java Web Application
  library-web:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      library-db:
        condition: service_healthy
    environment:
      # Override Spring Boot properties for the container environment
      SPRING_DATASOURCE_URL: jdbc:sqlserver://library-db:1433;databaseName=LibraryDB;encrypt=false
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: MyComplexPass123